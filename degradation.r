rm(list=ls())

library(tidyverse)
library(dplyr)
library(patchwork)
library(showtext)

showtext_auto()

luminance <- tibble::tribble(
      ~Aging,      ~Cell_ID, ~`220824`, ~`220825`, ~`220826`, ~`220829`, ~`220830`, ~`220831`,
   "250_250", "2317RAB04_1", 250.55681, 249.67721, 248.18263, 249.51165, 252.60888, 247.81739,
   "250_250", "2317RAB04_2", 248.76182, 247.80458, 245.74318, 247.62402,  250.4072, 245.32306,
   "250_250", "2317RAB04_3", 259.11885, 258.57101, 256.01152, 257.03489, 261.30472, 255.53479,
   "250_250", "2317RAB04_4", 267.75055, 266.30974, 264.78481, 267.46111, 268.82277, 264.60745,
   "250_250", "2317QAB02_1", 246.95422, 242.47145, 248.55926, 250.71634, 254.50611, 249.70518,
   "250_250", "2317QAB02_2", 246.66645, 249.05262, 254.38125, 257.03611, 261.72928,  250.8758,
   "250_250", "2317QAB02_3", 210.02354, 212.35283, 214.72733, 216.26496, 224.07961, 215.06443,
   "250_250", "2317QAB02_4",   193.092, 190.15361, 195.40708, 200.56586, 211.37165, 192.92767,
   "250_250", "2317UAB03_1", 260.27918, 256.59858, 252.17082, 252.82168, 261.03472, 251.08593,
   "250_250", "2317UAB03_2", 261.18556, 260.36866, 255.57939,  258.3411, 259.09433, 255.56867,
   "250_250", "2317UAB03_3", 256.76221, 256.99811, 251.67271, 254.29582, 256.65401, 252.26025,
   "250_250", "2317UAB03_4", 299.98617, 297.61087, 294.54902, 297.02056, 296.98477, 294.59457,
   "250_250", "2317QAB03_1", 244.66542, 621.79173, 0.0022795, 0.0017467, 0.0018344, 0.0024342,
   "250_250", "2317QAB03_2", 233.18571, 620.85134, 0.0031628, 0.0017963, 0.0018486, 0.0020225,
   "250_250", "2317QAB03_3", 240.35365, 565.97371, 0.0024979, 0.0016224, 0.0016622, 0.0023217,
   "250_250", "2317QAB03_4", 250.32937, 472.38507, 0.0031178, 0.0025829, 0.0018161, 0.0028731,
   "250_250", "2302HAB02_1", 239.58934, 238.39543, 236.06214, 236.94517, 240.90995, 237.09605,
   "250_250", "2302HAB02_2", 239.25487, 238.06742, 234.01073, 235.02544, 238.33401, 235.55614,
   "250_250", "2302HAB02_3", 253.16748, 252.92344, 250.06978,  250.9478, 254.69758, 250.67132,
   "250_250", "2302HAB02_4", 258.39833,  257.7484, 254.63055, 254.67437, 256.98233, 254.92748,
   "250_250", "2302HAA02_1", 233.80124, 230.45281, 228.25785, 230.80784, 233.40276, 227.44663,
   "250_250", "2302HAA02_2", 227.73274, 224.97184, 223.37229, 225.47145,  227.9039, 222.74984,
   "250_250", "2302HAA02_3",   223.873, 220.66762, 218.89049, 220.75025, 221.44765,   218.802,
   "250_250", "2302HAA02_4", 239.87113, 237.52882, 232.10972, 233.21908, 234.64416, 235.04374,
   "250_250", "2317RAB04_1", 256.49978, 256.31874,  253.6207, 254.25496,  260.2186, 254.05648,
   "250_250", "2317RAB04_2", 246.81377, 245.79699, 244.17565, 246.47666, 251.81934, 244.81103,
   "250_250", "2317RAB04_3", 263.63568, 264.20049, 261.26665,  263.5238, 266.35053, 261.75644,
   "250_250", "2317RAB04_4", 255.08884, 254.72405, 252.46153,  254.3267, 256.31719, 252.70886,
   "250_250", "2317SAB01_1", 243.02167,  243.3317, 242.27978, 244.31255, 247.45633, 242.19312,
   "250_250", "2317SAB01_2", 244.47106, 244.44715, 241.29999, 243.89336, 245.57832, 240.98692,
   "250_250", "2317SAB01_3", 250.71187,   250.864, 247.14267, 247.79958, 250.55803,  247.2512,
   "250_250", "2317SAB01_4",  243.6559, 239.45669, 240.02128, 242.21542,  241.9337, 238.13988,
  "1000_250", "2317NAB03_1",  235.1369, 234.51116, 233.63585, 233.66543, 238.43364, 233.37062,
  "1000_250", "2317NAB03_2", 236.12584, 235.23116,  234.1951, 234.14154, 237.30455, 232.76351,
  "1000_250", "2317NAB03_3",   253.368, 252.45896, 252.28554, 252.56102, 254.45175, 251.42669,
  "1000_250", "2317NAB03_4", 251.90876, 250.36082, 250.84395, 250.72436, 251.25534, 249.48566,
  "1000_250", "2317RAA02_1", 295.30254, 299.48099, 296.09658,   296.419, 301.66811, 294.76476,
  "1000_250", "2317RAA02_2",  276.5448, 278.29062, 276.23124, 276.52136, 280.17762, 274.46541,
  "1000_250", "2317RAA02_3", 291.25656, 289.76736, 289.58901, 288.00751, 293.04731, 288.29382,
  "1000_250", "2317RAA02_4", 261.92859, 257.76639, 258.88068, 264.06346, 262.77691, 261.20281,
  "1000_250", "2315XAA02_1", 244.81202,  249.3236, 247.86685,  247.7108, 252.92189, 247.82933,
  "1000_250", "2315XAA02_2", 240.57172, 242.36617,  239.6901, 239.51033, 244.16375, 239.23041,
  "1000_250", "2315XAA02_3", 243.41252, 242.06779, 240.56296, 240.05383, 243.63352, 239.63655,
  "1000_250", "2315XAA02_4",  227.5284, 225.11174, 224.73367, 224.64703, 228.16561, 223.20364,
  "1000_250", "2317RAA04_1", 257.42986,  259.0695, 257.73752,  258.1875, 263.49838, 256.09069,
  "1000_250", "2317RAA04_2", 257.47304, 258.61745, 255.98168, 256.82988, 261.79764, 254.52238,
  "1000_250", "2317RAA04_3", 263.55417, 268.96499, 267.86175, 267.60069, 272.41857, 266.08861,
  "1000_250", "2317RAA04_4", 275.47947,  277.2429,  275.3821, 275.03371, 279.69963, 274.05348,
  "1000_250", "2315QAB04_1",   226.422, 235.14549, 231.60203, 235.39665, 237.89413,   233.944,
  "1000_250", "2315QAB04_2",  235.8987, 243.68152, 244.87002, 246.55479, 250.72383, 246.30843,
  "1000_250", "2315QAB04_3", 202.08695, 216.29577, 215.76929,   216.775,  220.7606, 215.94114,
  "1000_250", "2315QAB04_4", 194.82623, 200.27129, 199.15519, 202.13169, 207.16269, 194.19586,
  "1000_250", "2204PAB01_1", 248.74869, 253.22082, 251.56029, 251.67734,  255.0476, 248.01463,
  "1000_250", "2204PAB01_2",  234.7514, 236.52193, 234.68169, 235.40081, 238.45826, 232.66708,
  "1000_250", "2204PAB01_3", 230.72751,  241.9906, 240.21391, 240.60742, 244.88561, 238.39239,
  "1000_250", "2204PAB01_4", 249.21082, 249.17326, 247.39981, 247.08692, 250.47557, 245.66198,
  "1000_250", "2302HAA01_1", 251.15961, 250.13862, 250.31887,   252.272,  250.9122, 250.77054,
  "1000_250", "2302HAA01_2",  256.7292, 257.75922, 256.02704, 260.38023, 265.13792, 258.47296,
  "1000_250", "2302HAA01_3", 216.41525, 215.80743, 213.96614, 216.78359, 222.52483, 216.90648,
  "1000_250", "2302HAA01_4", 197.70844, 198.37686, 191.58525, 204.05255, 201.70112, 197.30532,
  "1000_250", "2302HAB02_1", 230.21742, 228.66307, 226.36136, 227.86535, 231.18661, 226.29525,
  "1000_250", "2302HAB02_2",  228.4696,  224.7353, 224.46213, 224.94811, 227.82317, 224.64551,
  "1000_250", "2302HAB02_3", 225.79492, 222.10559, 222.03935, 221.90908, 225.25825, 220.93901,
  "1000_250", "2302HAB02_4", 248.31217, 241.19793, 240.82252, 241.78134, 244.97785, 239.28335,
  "2000_250", "2302HAB01_1", 221.08276, 220.58095, 219.15871, 219.18709, 220.72277,  216.7743,
  "2000_250", "2302HAB01_2", 237.60632, 236.63851, 235.49162, 234.32808,  237.0805, 233.24593,
  "2000_250", "2302HAB01_3", 253.90307, 253.38255, 250.50458, 248.26348, 251.95396, 249.70156,
  "2000_250", "2302HAB01_4", 258.95877,  261.4732, 256.88279, 253.76345, 255.18958, 255.30734,
  "2000_250", "2315WAB01_1", 264.45054, 267.69285, 271.71698, 282.06662, 281.75643, 286.22824,
  "2000_250", "2315WAB01_2", 263.63255, 269.93513, 271.60384, 284.12039, 289.91233, 289.81622,
  "2000_250", "2315WAB01_3",  242.5784, 249.73407, 250.19631, 262.93708, 268.41046, 269.72268,
  "2000_250", "2315WAB01_4", 216.10864, 222.33247, 215.27863, 237.40343, 240.48023, 235.81257,
  "2000_250", "2204PAB01_1", 232.79992, 234.63951, 232.96355, 234.11592, 235.44693,  229.6833,
  "2000_250", "2204PAB01_2", 246.15764, 247.41675, 245.51362, 244.87496, 248.42138, 243.58704,
  "2000_250", "2204PAB01_3", 267.65444, 269.45264, 268.27073, 267.45855, 270.14043, 264.90329,
  "2000_250", "2204PAB01_4", 261.11642, 262.82659, 261.94564, 259.33622, 260.65078, 257.52291,
  "2000_250", "2317NAB03_1", 245.08891, 246.33981, 243.74844, 244.82908, 248.22737,   241.838,
  "2000_250", "2317NAB03_2", 244.88922, 245.56553, 243.22369,  245.0205,  247.1545, 241.30842,
  "2000_250", "2317NAB03_3", 243.65038, 243.60344, 242.65424, 243.64382, 246.94892, 242.77443,
  "2000_250", "2317NAB03_4", 261.01287, 261.45745, 259.77061, 258.92951, 260.67374, 258.31854
  )
luminance %>% 
  separate(Cell_ID, c('cell_id', 'position')) %>% 
  mutate(`220825`= `220825`/`220824`) %>% 
  mutate(`220826`= `220826`/`220824`) %>%  
  mutate(`220829`= `220829`/`220824`) %>% 
  mutate(`220830`= `220830`/`220824`) %>% 
  mutate(`220831`= `220831`/`220824`) %>% 
  mutate(`220824`= `220824`/`220824`) %>% 
  pivot_longer(cols = `220824`:`220831`, names_to = "date", values_to = "luminance") %>% 
  mutate(date = as.Date(date, format = "%y%m%d")) %>%
  filter(luminance > 0.5 & luminance < 1.5) %>% 
  ggplot(aes(x=as.factor(date), y=luminance*100, col=as.factor(position)))+geom_boxplot()+
  facet_grid(Aging~.,labeller = label_both)+
  labs(col = "Position", title = "Aging 시간에 따른 휘도변화", 
       y="Normallized Luminace (초기치 대비)",
       x= "Date")


a <- luminance %>% 
  separate(Cell_ID, c('cell_id', 'position')) %>% 
  mutate(`220825`= `220825`/`220824`) %>% 
  mutate(`220826`= `220826`/`220824`) %>%  
  mutate(`220829`= `220829`/`220824`) %>% 
  mutate(`220830`= `220830`/`220824`) %>% 
  mutate(`220831`= `220831`/`220824`) %>% 
  mutate(`220824`= `220824`/`220824`) %>% 
  pivot_longer(cols = `220824`:`220831`, names_to = "date", values_to = "luminance") %>% 
  mutate(date = as.Date(date, format = "%y%m%d")) %>%
  filter(luminance > 0.5 & luminance < 1.5) %>% 
  #filter(date=="2022-08-31") %>% 
  group_by(date,Aging) %>% summarise(max=max(luminance),min=min(luminance), .groups='drop') %>% 
  mutate(max = max/max,
         min = min/max) %>% 
  arrange(Aging, date) %>% 
  mutate(num = c(1:n())) %>% 
  mutate(day = date-min(date)) 


a%>% 
  ggplot(aes(x=day, y=min, col=Aging))+geom_point()+geom_line()

dev.off()  

getwd()
setwd("D:/Non_Documents/AI/R/image")


d <- data.frame(
  x = c(0, 2, 2, 0, 0, 2, 2, 0),
  y = c(0, 0, 1, 1, 1, 1, 2, 2),
  t = c('a', 'a', 'a','a' ,'b', 'b', 'b', 'b'),
  alpha = rep(1:2, each = 4))

################## 시간에 따른 이미지 저장 

for (i in 1:nrow(a)){
p <- ggplot(d,aes(x, y, group = t, alpha = alpha )) +
  geom_polygon() +
  scale_alpha_continuous(range = c(1-a$min[i], 1-a$max[i]), guide = F)+
  labs(title = paste0(a$day[i],"days, ",a$Aging[i]))+
  theme(plot.background = element_rect(colour = "black", size = 2),
        panel.background = element_blank(),
        axis.title.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.y=element_blank(),
        axis.text.x=element_blank() )+
  geom_text(aes(label = round(a$min[i],2), x=1, y=0.5), col="black", size=5)
  
ggsave(paste0(a$num[i],"_", a$day[i],"day_", a$Aging[i],".jpg"),  p,  dpi = 300, height = 2, width = 2)
print(i)
}

#################################

setwd("D:/Non_Documents/AI/R/image")
src_dir <- getwd()
src_file <- list.files(src_dir)
src_file_cnt <- length(src_file)
temp <-  list.files(pattern="*.jpg")
## 파일 개수 객체로 만들기


## 폴더내 파일 loop 로 돌려서 불러오기
order <- c(1, 11:18, 2:10)
dev.off()

par(mfrow = c(3,src_file_cnt/3))
par("mar")

par(mar=c(1,1,1,1))
library(jpeg)

for ( i in order) {
  print(temp[i])
  temp2 <-  readJPEG(paste(temp[i]))
  plot(1:2, type='n',
       axes=FALSE, #축제거거
       xaxt='n', #x축 눈금 제거
       yaxt='n', #y축 눈금 제거
       ann=FALSE #축이름 제거
  )
  rasterImage(as.raster(temp2), 1, 1, 2, 2, interpolate=FALSE)
}



###################################




total %>%as_tibble() %>% mutate(day = date-min(date))  %>% mutate(num=c(1:n())) %>% 
  #filter(date=="2022-08-31") %>% filter(Aging == "250_250") %>% 
  ggplot(aes(x, y, group = t, fill= color))+
  geom_polygon() +
  #scale_color_manual(values = col_list) +
  #scale_fill_manual(values = col_list)  +
  labs(title = "Aging 2000_250 after 7days")+
  theme(plot.background = element_rect(colour = "black", size = 2),
        panel.background = element_blank(),
        axis.title.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.y=element_blank(),
        axis.text.x=element_blank() ) +
    facet_wrap(Aging~day, nrow=3, labeller="label_both")


p1+p2+p3
 
#점의 좌표 설정



library(sp)
Srs1 = Polygons(list(Polygon(cbind(c(1,4,4,1),c(1,1,2,2,1)))), "s1")
Srs2 = Polygons(list(Polygon(cbind(c(1,4,4,1),c(2,2,3,3,2)))), "s2")

SpDF <- SpatialPolygonsDataFrame( SpatialPolygons(list(Srs1,Srs2)), 
                                  data.frame( z=0:1, row.names=c("s1","s2") ) )
spplot(SpDF, zcol="z")
spplot(SpDF, zcol="z", col=NA)
spplot(SpDF, zcol="z", col.regions=gray(seq(0,1,.01)))


##########################
d=data.frame(c=colors(), y=seq(0, length(colors())-1)%%66, x=seq(0, length(colors())-1)%/%66)
ggplot() +
  scale_x_continuous(name="", breaks=NULL, expand=c(0, 0)) +
  scale_y_continuous(name="", breaks=NULL, expand=c(0, 0)) +
  scale_fill_identity() +
  geom_rect(data=d, mapping=aes(xmin=x, xmax=x+1, ymin=y, ymax=y+1), fill="white") +
  geom_rect(data=d, mapping=aes(xmin=x+0.05, xmax=x+0.95, ymin=y+0.5, ymax=y+1, fill=c)) +
  geom_text(data=d, mapping=aes(x=x+0.5, y=y+0.5, label=c), colour="black", hjust=0.5, vjust=1, size=3)
